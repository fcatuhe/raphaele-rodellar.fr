# Load your application, this activates the Parklife/Rails integration and gives
# you access to route helpers and models in this file.
require_relative "config/environment"

staging = ActiveModel::Type::Boolean.new.cast(ENV["STAGING"])
live_production = Rails.env.production? && !staging

base_url =
  if Rails.env.production?
    staging ? ENV.fetch("BASE_URL", "https://staging.raphaele-rodellar.fr") : ENV.fetch("BASE_URL", "https://raphaele-rodellar.fr")
  else
    ENV.fetch("BASE_URL", "http://localhost:3000")
  end

Parklife.application.configure do |config|
  # Serve trailing slash-less URLs from GitHub Pages.
  config.nested_index = false

  config.base = base_url
  config.build_dir = Rails.root.join("build").to_s

  # See configuration options here:
  # https://github.com/benpickles/parklife#configuration
end

Parklife.application.after_build do |application|
  sitemap = Sitemap.new(
    base_url: application.config.base,
    build_dir: application.config.build_dir,
    generate_robots: true,
    disallow_all: !live_production
  )

  return Rails.logger.error("Error generating sitemap: #{sitemap.errors.full_messages.join(', ')}") unless sitemap.valid?

  sitemap.generate!
end

Parklife.application.routes do
  root crawl: true

  # Add further paths not discovered by crawling from the root - Parklife's
  # Rails integration lets you use the app's route helpers:
  #
  # get hidden_pages_path, crawl: true
  # get feed_path(format: :atom)

  # Services typically allow a custom 404 page.
  # get '/404.html'
end
